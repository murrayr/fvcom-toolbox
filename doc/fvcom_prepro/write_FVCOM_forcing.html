<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of write_FVCOM_forcing</title>
  <meta name="keywords" content="write_FVCOM_forcing">
  <meta name="description" content="Write data out to FVCOM NetCDF forcing file.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">fvcom_prepro</a> &gt; write_FVCOM_forcing.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for fvcom_prepro&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>write_FVCOM_forcing
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>Write data out to FVCOM NetCDF forcing file.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function write_FVCOM_forcing(Mobj, fileprefix, data, infos, fver) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Write data out to FVCOM NetCDF forcing file.

 write_FVCOM_forcing(Mobj, fvcom_forcing_file, data, infos, fver)

 DESCRIPTION:
   Takes the given interpolated data (e.g. from grid2fvcom) and writes out
   to a NetCDF file.

 INPUT:
   Mobj - MATLAB mesh object containing fields:
       tri - triangulation table for the unstructured grid
       nVerts - number of grid vertices (nodes)
       nElems - number of grid elements
       nativeCoords - model coordinate type ('cartesian' or 'spherical')
       x, y or lon, lat - node positions (depending on nativeCoords value)
   fileprefix - Output NetCDF file prefix (plus path) will be
       fileprefix_{wnd,hfx,evap}.nc if fver is '3.1.0', otherwise output
       files will be fileprefix_wnd.nc.
   data - Struct of the data to be written out.
   infos - Additional remarks to be written to the &quot;infos&quot; NetCDF variable
   fver - Output for version 3.1.0 or 3.1.6. The latter means all the
       forcing can go in a single file, the former needs separate files
       for specific forcing data (wind, heating and precipitation).

 The fields in data may be called any of:
     - 'u10', 'v10', 'uwnd', 'vwnd' - wind components
     - 'slp'       - sea level pressure
     - 'pevpr'     - evaporation
     - 'prate'     - precipitation
     - 'slp'       - sea level pressure
     - 'nlwrs'     - net longwave radiation*,**
     - 'nswrs'     - net shortwave radiation*,**
     - 'shtfl'     - sensible heat net flux*,**
     - 'lhtfl'     - latent heat net flux*,**
     - 'lon'       - longitude (vector)
     - 'lat'       - latitude (vector)
     - 'x'         - eastings (vector)
     - 'y'         - northings (vector)
     - 'nshf'      - pre-computed net surface heat flux**

 Fields marked with an * are combined to form the &quot;surface net heat flux&quot;
 (nshf) as follows:

   nshf = -nlwrs + -nswrs - lhtfl - shtfl;

 ** Alternatively, a new field 'nshf' (net surface heat flux) can be
 supplied, in which case shtfl and lhtfl are not necessary as their only
 function is in the calculation of net surface heat flux. This approach
 eliminates the need to interpolate so many variables onto the FVCOM grid,
 thus decreasing the time needed to generate the FVCOM input files.

 OUTPUT:
   FVCOM wind speed forcing NetCDF file(s)

 EXAMPLE USAGE:
   windBase = '/path/to/output/casename_wnd.nc';
   write_FVCOM_forcing(Mobj, windBase, data, ...
       'FVCOM atmospheric forcing data', '3.1.6');

 Author(s):
   Pierre Cazenave (Plymouth Marine Laboratory)
   Karen Thurston (National Oceanography Centre, Liverpool)

 PWC Revision history:
   2012-11-01 - First version based on the parts of grid2fvcom_U10V10.m
   which dealt with writing the NetCDF file. This version now dynamically
   deals with varying numbers of forcing data.
   2012-11-09 - Add the correct calculation for the net surface heat flux.
   2013-02-14 - Fix the surface net heat flux sign convention, include the
   longwave radiation variable and add support for a new field in the
   input struct ('nshf') which contains the pre-computed net surface heat
   flux.
   2013-05-13 - Fix the evaporation to use the correct variable from NCEP
   (pevpr rather than P_E which is actually the precipitation minus the
   evaporation in Et). The data in Et are calcaulated from lhtfl whereas
   pevpr comes directly from NCEP and to me it seems more sensible to use
   that to maintain consistency.
   2013-05-14 - Add example usage to the help and specify which fields are
   required in Mobj.

 KJT Revision history:
   2013-01-16 - Added support for output of sea level pressure.

==========================================================================</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="nodes2elems.html" class="code" title="function [fieldout] = nodes2elems(fieldin,Mobj)">nodes2elems</a>	Transfer a field from vertices to elements</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function write_FVCOM_forcing(Mobj, fileprefix, data, infos, fver)</a>
0002 <span class="comment">% Write data out to FVCOM NetCDF forcing file.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% write_FVCOM_forcing(Mobj, fvcom_forcing_file, data, infos, fver)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% DESCRIPTION:</span>
0007 <span class="comment">%   Takes the given interpolated data (e.g. from grid2fvcom) and writes out</span>
0008 <span class="comment">%   to a NetCDF file.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% INPUT:</span>
0011 <span class="comment">%   Mobj - MATLAB mesh object containing fields:</span>
0012 <span class="comment">%       tri - triangulation table for the unstructured grid</span>
0013 <span class="comment">%       nVerts - number of grid vertices (nodes)</span>
0014 <span class="comment">%       nElems - number of grid elements</span>
0015 <span class="comment">%       nativeCoords - model coordinate type ('cartesian' or 'spherical')</span>
0016 <span class="comment">%       x, y or lon, lat - node positions (depending on nativeCoords value)</span>
0017 <span class="comment">%   fileprefix - Output NetCDF file prefix (plus path) will be</span>
0018 <span class="comment">%       fileprefix_{wnd,hfx,evap}.nc if fver is '3.1.0', otherwise output</span>
0019 <span class="comment">%       files will be fileprefix_wnd.nc.</span>
0020 <span class="comment">%   data - Struct of the data to be written out.</span>
0021 <span class="comment">%   infos - Additional remarks to be written to the &quot;infos&quot; NetCDF variable</span>
0022 <span class="comment">%   fver - Output for version 3.1.0 or 3.1.6. The latter means all the</span>
0023 <span class="comment">%       forcing can go in a single file, the former needs separate files</span>
0024 <span class="comment">%       for specific forcing data (wind, heating and precipitation).</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% The fields in data may be called any of:</span>
0027 <span class="comment">%     - 'u10', 'v10', 'uwnd', 'vwnd' - wind components</span>
0028 <span class="comment">%     - 'slp'       - sea level pressure</span>
0029 <span class="comment">%     - 'pevpr'     - evaporation</span>
0030 <span class="comment">%     - 'prate'     - precipitation</span>
0031 <span class="comment">%     - 'slp'       - sea level pressure</span>
0032 <span class="comment">%     - 'nlwrs'     - net longwave radiation*,**</span>
0033 <span class="comment">%     - 'nswrs'     - net shortwave radiation*,**</span>
0034 <span class="comment">%     - 'shtfl'     - sensible heat net flux*,**</span>
0035 <span class="comment">%     - 'lhtfl'     - latent heat net flux*,**</span>
0036 <span class="comment">%     - 'lon'       - longitude (vector)</span>
0037 <span class="comment">%     - 'lat'       - latitude (vector)</span>
0038 <span class="comment">%     - 'x'         - eastings (vector)</span>
0039 <span class="comment">%     - 'y'         - northings (vector)</span>
0040 <span class="comment">%     - 'nshf'      - pre-computed net surface heat flux**</span>
0041 <span class="comment">%</span>
0042 <span class="comment">% Fields marked with an * are combined to form the &quot;surface net heat flux&quot;</span>
0043 <span class="comment">% (nshf) as follows:</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%   nshf = -nlwrs + -nswrs - lhtfl - shtfl;</span>
0046 <span class="comment">%</span>
0047 <span class="comment">% ** Alternatively, a new field 'nshf' (net surface heat flux) can be</span>
0048 <span class="comment">% supplied, in which case shtfl and lhtfl are not necessary as their only</span>
0049 <span class="comment">% function is in the calculation of net surface heat flux. This approach</span>
0050 <span class="comment">% eliminates the need to interpolate so many variables onto the FVCOM grid,</span>
0051 <span class="comment">% thus decreasing the time needed to generate the FVCOM input files.</span>
0052 <span class="comment">%</span>
0053 <span class="comment">% OUTPUT:</span>
0054 <span class="comment">%   FVCOM wind speed forcing NetCDF file(s)</span>
0055 <span class="comment">%</span>
0056 <span class="comment">% EXAMPLE USAGE:</span>
0057 <span class="comment">%   windBase = '/path/to/output/casename_wnd.nc';</span>
0058 <span class="comment">%   write_FVCOM_forcing(Mobj, windBase, data, ...</span>
0059 <span class="comment">%       'FVCOM atmospheric forcing data', '3.1.6');</span>
0060 <span class="comment">%</span>
0061 <span class="comment">% Author(s):</span>
0062 <span class="comment">%   Pierre Cazenave (Plymouth Marine Laboratory)</span>
0063 <span class="comment">%   Karen Thurston (National Oceanography Centre, Liverpool)</span>
0064 <span class="comment">%</span>
0065 <span class="comment">% PWC Revision history:</span>
0066 <span class="comment">%   2012-11-01 - First version based on the parts of grid2fvcom_U10V10.m</span>
0067 <span class="comment">%   which dealt with writing the NetCDF file. This version now dynamically</span>
0068 <span class="comment">%   deals with varying numbers of forcing data.</span>
0069 <span class="comment">%   2012-11-09 - Add the correct calculation for the net surface heat flux.</span>
0070 <span class="comment">%   2013-02-14 - Fix the surface net heat flux sign convention, include the</span>
0071 <span class="comment">%   longwave radiation variable and add support for a new field in the</span>
0072 <span class="comment">%   input struct ('nshf') which contains the pre-computed net surface heat</span>
0073 <span class="comment">%   flux.</span>
0074 <span class="comment">%   2013-05-13 - Fix the evaporation to use the correct variable from NCEP</span>
0075 <span class="comment">%   (pevpr rather than P_E which is actually the precipitation minus the</span>
0076 <span class="comment">%   evaporation in Et). The data in Et are calcaulated from lhtfl whereas</span>
0077 <span class="comment">%   pevpr comes directly from NCEP and to me it seems more sensible to use</span>
0078 <span class="comment">%   that to maintain consistency.</span>
0079 <span class="comment">%   2013-05-14 - Add example usage to the help and specify which fields are</span>
0080 <span class="comment">%   required in Mobj.</span>
0081 <span class="comment">%</span>
0082 <span class="comment">% KJT Revision history:</span>
0083 <span class="comment">%   2013-01-16 - Added support for output of sea level pressure.</span>
0084 <span class="comment">%</span>
0085 <span class="comment">%==========================================================================</span>
0086 
0087 multi_out = false; <span class="comment">% default to 3.1.6, single output file</span>
0088 <span class="keyword">if</span> nargin &lt; 4 || nargin &gt; 5
0089     error(<span class="string">'Incorrect number of arguments'</span>)
0090 <span class="keyword">elseif</span> nargin == 5
0091     <span class="keyword">if</span> strcmpi(fver, <span class="string">'3.1.0'</span>)
0092         multi_out = true;
0093     <span class="keyword">end</span>
0094 <span class="keyword">end</span>
0095 
0096 subname = <span class="string">'write_FVCOM_forcing'</span>;
0097 
0098 <span class="keyword">global</span> ftbverbose;
0099 <span class="keyword">if</span> ftbverbose
0100     fprintf(<span class="string">'\nbegin : %s \n'</span>, subname)
0101 <span class="keyword">end</span>
0102 
0103 tri = Mobj.tri;
0104 nNodes = Mobj.nVerts;
0105 nElems = Mobj.nElems;
0106 ntimes = numel(data.time);
0107 
0108 <span class="keyword">if</span> strcmpi(Mobj.nativeCoords, <span class="string">'cartesian'</span>)
0109     x = Mobj.x;
0110     y = Mobj.y;
0111 <span class="keyword">else</span>
0112     x = Mobj.lon;
0113     y = Mobj.lat;
0114 <span class="keyword">end</span>
0115 <span class="comment">% Create a string for each variable's coordinate attribute</span>
0116 coordString = sprintf(<span class="string">'FVCOM %s coordinates'</span>, Mobj.nativeCoords);
0117 
0118 <span class="comment">% Create element vertices positions</span>
0119 xc = <a href="nodes2elems.html" class="code" title="function [fieldout] = nodes2elems(fieldin,Mobj)">nodes2elems</a>(x, Mobj);
0120 yc = <a href="nodes2elems.html" class="code" title="function [fieldout] = nodes2elems(fieldin,Mobj)">nodes2elems</a>(y, Mobj);
0121 
0122 <span class="comment">%--------------------------------------------------------------------------</span>
0123 <span class="comment">% Create the NetCDF header for the FVCOM forcing file</span>
0124 <span class="comment">%--------------------------------------------------------------------------</span>
0125 
0126 <span class="keyword">if</span> multi_out
0127     suffixes = {<span class="string">'_wnd'</span>, <span class="string">'_hfx'</span>, <span class="string">'_evap'</span>, <span class="string">'_air_press'</span>};
0128 <span class="keyword">else</span>
0129     suffixes = {<span class="string">'_wnd'</span>};
0130 <span class="keyword">end</span>
0131 
0132 <span class="comment">% We use this variable to indicate whether we were given precalculated net</span>
0133 <span class="comment">% surface heat flux.</span>
0134 nshf = 0;
0135 
0136 <span class="keyword">for</span> i=1:length(suffixes)
0137     nc = netcdf.create([fileprefix, suffixes{i}, <span class="string">'.nc'</span>], <span class="string">'clobber'</span>);
0138 
0139 <span class="comment">%     netcdf.putAtt(nc,netcdf.getConstant('NC_GLOBAL'),'type','FVCOM Forcing File')</span>
0140     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'title'</span>,<span class="string">'FVCOM Forcing File'</span>)
0141     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'institution'</span>,<span class="string">'Plymouth Marine Laboratory'</span>)
0142     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'source'</span>,<span class="string">'FVCOM grid (unstructured) surface forcing'</span>)
0143     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'history'</span>,[<span class="string">'File created on '</span>, datestr(now, <span class="string">'yyyy-mm-dd HH:MM:SS'</span>), <span class="string">' with write_FVCOM_forcing.m from the MATLAB fvcom-toolbox (https://github.com/pwcazenave/fvcom-toolbox)'</span>])
0144     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'references'</span>,<span class="string">'http://fvcom.smast.umassd.edu, http://codfish.smast.umassd.edu'</span>)
0145     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'Conventions'</span>,<span class="string">'CF-1.0'</span>)
0146 <span class="comment">%     netcdf.putAtt(nc,netcdf.getConstant('NC_GLOBAL'),'infos',infos)</span>
0147     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'CoordinateSystem'</span>,Mobj.nativeCoords)
0148     netcdf.putAtt(nc,netcdf.getConstant(<span class="string">'NC_GLOBAL'</span>),<span class="string">'CoordinateProjection'</span>,<span class="string">'init=epsg:4326'</span>) <span class="comment">% WGS84?</span>
0149 
0150     <span class="comment">% Dimensions</span>
0151     nele_dimid=netcdf.defDim(nc,<span class="string">'nele'</span>,nElems);
0152     node_dimid=netcdf.defDim(nc,<span class="string">'node'</span>,nNodes);
0153     three_dimid=netcdf.defDim(nc,<span class="string">'three'</span>,3);
0154     time_dimid=netcdf.defDim(nc,<span class="string">'time'</span>,netcdf.getConstant(<span class="string">'NC_UNLIMITED'</span>));
0155     datestrlen_dimid=netcdf.defDim(nc,<span class="string">'DateStrLen'</span>,26);
0156 
0157     <span class="comment">% Space variables</span>
0158     x_varid=netcdf.defVar(nc,<span class="string">'x'</span>,<span class="string">'NC_FLOAT'</span>,node_dimid);
0159     netcdf.putAtt(nc,x_varid,<span class="string">'long_name'</span>,<span class="string">'nodal x-coordinate'</span>);
0160     netcdf.putAtt(nc,x_varid,<span class="string">'units'</span>,<span class="string">'meters'</span>);
0161 
0162     y_varid=netcdf.defVar(nc,<span class="string">'y'</span>,<span class="string">'NC_FLOAT'</span>,node_dimid);
0163     netcdf.putAtt(nc,y_varid,<span class="string">'long_name'</span>,<span class="string">'nodal y-coordinate'</span>);
0164     netcdf.putAtt(nc,y_varid,<span class="string">'units'</span>,<span class="string">'meters'</span>);
0165 
0166     xc_varid=netcdf.defVar(nc,<span class="string">'xc'</span>,<span class="string">'NC_FLOAT'</span>,nele_dimid);
0167     netcdf.putAtt(nc,xc_varid,<span class="string">'long_name'</span>,<span class="string">'zonal x-coordinate'</span>);
0168     netcdf.putAtt(nc,xc_varid,<span class="string">'units'</span>,<span class="string">'meters'</span>);
0169 
0170     yc_varid=netcdf.defVar(nc,<span class="string">'yc'</span>,<span class="string">'NC_FLOAT'</span>,nele_dimid);
0171     netcdf.putAtt(nc,yc_varid,<span class="string">'long_name'</span>,<span class="string">'zonal y-coordinate'</span>);
0172     netcdf.putAtt(nc,yc_varid,<span class="string">'units'</span>,<span class="string">'meters'</span>);
0173 
0174     nv_varid=netcdf.defVar(nc,<span class="string">'nv'</span>,<span class="string">'NC_INT'</span>,[nele_dimid, three_dimid]);
0175     netcdf.putAtt(nc,nv_varid,<span class="string">'long_name'</span>,<span class="string">'nodes surrounding element'</span>);
0176 
0177     <span class="comment">% Time variables</span>
0178     time_varid=netcdf.defVar(nc,<span class="string">'time'</span>,<span class="string">'NC_FLOAT'</span>,time_dimid);
0179     netcdf.putAtt(nc,time_varid,<span class="string">'long_name'</span>,<span class="string">'time'</span>);
0180     netcdf.putAtt(nc,time_varid,<span class="string">'units'</span>,<span class="string">'days since 1858-11-17 00:00:00'</span>);
0181     netcdf.putAtt(nc,time_varid,<span class="string">'format'</span>,<span class="string">'modified julian day (MJD)'</span>);
0182     netcdf.putAtt(nc,time_varid,<span class="string">'time_zone'</span>,<span class="string">'UTC'</span>);
0183 
0184     itime_varid=netcdf.defVar(nc,<span class="string">'Itime'</span>,<span class="string">'NC_INT'</span>,time_dimid);
0185     netcdf.putAtt(nc,itime_varid,<span class="string">'units'</span>,<span class="string">'days since 1858-11-17 00:00:00'</span>);
0186     netcdf.putAtt(nc,itime_varid,<span class="string">'format'</span>,<span class="string">'modified julian day (MJD)'</span>);
0187     netcdf.putAtt(nc,itime_varid,<span class="string">'time_zone'</span>,<span class="string">'UTC'</span>);
0188 
0189     itime2_varid=netcdf.defVar(nc,<span class="string">'Itime2'</span>,<span class="string">'NC_INT'</span>,time_dimid);
0190     netcdf.putAtt(nc,itime2_varid,<span class="string">'units'</span>,<span class="string">'msec since 00:00:00'</span>);
0191     netcdf.putAtt(nc,itime2_varid,<span class="string">'time_zone'</span>,<span class="string">'UTC'</span>);
0192     netcdf.putAtt(nc,itime2_varid,<span class="string">'long_name'</span>,<span class="string">'time'</span>);
0193 
0194     times_varid=netcdf.defVar(nc,<span class="string">'Times'</span>,<span class="string">'NC_CHAR'</span>,[datestrlen_dimid,time_dimid]);
0195     netcdf.putAtt(nc,times_varid,<span class="string">'long_name'</span>,<span class="string">'Calendar Date'</span>);
0196     netcdf.putAtt(nc,times_varid,<span class="string">'format'</span>,<span class="string">'String: Calendar Time'</span>);
0197     netcdf.putAtt(nc,times_varid,<span class="string">'time_zone'</span>,<span class="string">'UTC'</span>);
0198 
0199     <span class="comment">% Since we have a dynamic number of variables in the struct, try to be a</span>
0200     <span class="comment">% bit clever about how to create the output variables.</span>
0201     fnames = fieldnames(data);
0202     used_varids = cell(0);
0203     used_fnames = cell(0);
0204     used_dims = cell(0); <span class="comment">% exclude time (assume all variables vary in time)</span>
0205 
0206     <span class="keyword">for</span> vv=1:length(fnames)
0207         <span class="comment">% Need to check both whether we have the data but also whether</span>
0208         <span class="comment">% we're outputting to several NetCDF files. If so, we drop some</span>
0209         <span class="comment">% variables if we're in the wrong file loop.</span>
0210         <span class="keyword">switch</span> fnames{vv}
0211             <span class="keyword">case</span> {<span class="string">'uwnd'</span>, <span class="string">'u10'</span>}
0212                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_wnd'</span>) || ~multi_out
0213                     <span class="comment">% wind components (assume we have v if we have u)</span>
0214 
0215                     <span class="comment">% On the elements</span>
0216                     u10_varid=netcdf.defVar(nc,<span class="string">'U10'</span>,<span class="string">'NC_FLOAT'</span>,[nele_dimid, time_dimid]);
0217                     netcdf.putAtt(nc,u10_varid,<span class="string">'long_name'</span>,<span class="string">'Eastward Wind Speed'</span>);
0218 <span class="comment">%                     netcdf.putAtt(nc,u10_varid,'standard_name','Eastward Wind Speed');</span>
0219                     netcdf.putAtt(nc,u10_varid,<span class="string">'units'</span>,<span class="string">'m/s'</span>);
0220                     netcdf.putAtt(nc,u10_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0221                     netcdf.putAtt(nc,u10_varid,<span class="string">'coordinates'</span>,coordString);
0222                     netcdf.putAtt(nc,u10_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0223 
0224                     v10_varid=netcdf.defVar(nc,<span class="string">'V10'</span>,<span class="string">'NC_FLOAT'</span>,[nele_dimid, time_dimid]);
0225                     netcdf.putAtt(nc,v10_varid,<span class="string">'long_name'</span>,<span class="string">'Northward Wind Speed'</span>);
0226 <span class="comment">%                     netcdf.putAtt(nc,v10_varid,'standard_name','Northward Wind Speed');</span>
0227                     netcdf.putAtt(nc,v10_varid,<span class="string">'units'</span>,<span class="string">'m/s'</span>);
0228                     netcdf.putAtt(nc,v10_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0229                     netcdf.putAtt(nc,v10_varid,<span class="string">'coordinates'</span>,coordString);
0230                     netcdf.putAtt(nc,v10_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0231 
0232                     uwind_varid=netcdf.defVar(nc,<span class="string">'uwind_speed'</span>,<span class="string">'NC_FLOAT'</span>,[nele_dimid, time_dimid]);
0233                     netcdf.putAtt(nc,uwind_varid,<span class="string">'long_name'</span>,<span class="string">'Eastward Wind Speed'</span>);
0234                     netcdf.putAtt(nc,uwind_varid,<span class="string">'standard_name'</span>,<span class="string">'Wind Speed'</span>);
0235                     netcdf.putAtt(nc,uwind_varid,<span class="string">'units'</span>,<span class="string">'m/s'</span>);
0236                     netcdf.putAtt(nc,uwind_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0237                     netcdf.putAtt(nc,uwind_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0238 
0239                     vwind_varid=netcdf.defVar(nc,<span class="string">'vwind_speed'</span>,<span class="string">'NC_FLOAT'</span>,[nele_dimid, time_dimid]);
0240                     netcdf.putAtt(nc,vwind_varid,<span class="string">'long_name'</span>,<span class="string">'Northward Wind Speed'</span>);
0241                     netcdf.putAtt(nc,vwind_varid,<span class="string">'standard_name'</span>,<span class="string">'Wind Speed'</span>);
0242                     netcdf.putAtt(nc,vwind_varid,<span class="string">'units'</span>,<span class="string">'m/s'</span>);
0243                     netcdf.putAtt(nc,vwind_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0244                     netcdf.putAtt(nc,vwind_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0245 
0246                     <span class="comment">% Only on the elements (both U10/V10 and uwind_speed and</span>
0247                     <span class="comment">% vwind_speed).</span>
0248                     used_varids = [used_varids, {<span class="string">'u10_varid'</span>, <span class="string">'v10_varid'</span>, <span class="string">'uwind_varid'</span>, <span class="string">'vwind_varid'</span>}];
0249                     used_fnames = [used_fnames, {<span class="string">'uwnd'</span>, <span class="string">'vwnd'</span>, <span class="string">'uwnd'</span>, <span class="string">'vwnd'</span>}];
0250                     used_dims = [used_dims, {<span class="string">'nElems'</span>, <span class="string">'nElems'</span>, <span class="string">'nElems'</span>, <span class="string">'nElems'</span>}];
0251                 <span class="keyword">end</span>
0252                 
0253             <span class="keyword">case</span> {<span class="string">'vwnd'</span>, <span class="string">'v10'</span>}
0254                 <span class="comment">% We dealt with these in the u component section above, so</span>
0255                 <span class="comment">% just pass silently.</span>
0256                 true;
0257 
0258             <span class="keyword">case</span> <span class="string">'slp'</span>
0259                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_air_press'</span>) || ~multi_out
0260                     <span class="comment">% Sea level pressure</span>
0261                     slp_varid=netcdf.defVar(nc,<span class="string">'air_pressure'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0262                     netcdf.putAtt(nc,slp_varid,<span class="string">'long_name'</span>,<span class="string">'Surface air pressure'</span>);
0263                     netcdf.putAtt(nc,slp_varid,<span class="string">'units'</span>,<span class="string">'Pa'</span>);
0264                     netcdf.putAtt(nc,slp_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0265                     netcdf.putAtt(nc,slp_varid,<span class="string">'coordinates'</span>,coordString);
0266                     netcdf.putAtt(nc,slp_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0267 
0268                     used_varids = [used_varids, <span class="string">'slp_varid'</span>];
0269                     used_fnames = [used_fnames, fnames{vv}];
0270                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0271                 <span class="keyword">end</span>
0272 
0273             <span class="keyword">case</span> {<span class="string">'pevpr'</span>, <span class="string">'Et'</span>}
0274                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_evap'</span>) || ~multi_out
0275                     <span class="comment">% Evaporation</span>
0276                     pevpr_varid=netcdf.defVar(nc,<span class="string">'evap'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0277                     netcdf.putAtt(nc,pevpr_varid,<span class="string">'long_name'</span>,<span class="string">'Evaporation'</span>);
0278                     netcdf.putAtt(nc,pevpr_varid,<span class="string">'description'</span>,<span class="string">'Evaporation, ocean lose water is negative'</span>);
0279                     netcdf.putAtt(nc,pevpr_varid,<span class="string">'units'</span>,<span class="string">'m s-1'</span>);
0280                     netcdf.putAtt(nc,pevpr_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0281                     netcdf.putAtt(nc,pevpr_varid,<span class="string">'coordinates'</span>,coordString);
0282                     netcdf.putAtt(nc,pevpr_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0283 
0284                     used_varids = [used_varids, <span class="string">'pevpr_varid'</span>];
0285                     used_fnames = [used_fnames, fnames{vv}];
0286                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0287                 <span class="keyword">end</span>
0288 
0289             <span class="keyword">case</span> {<span class="string">'prate'</span>, <span class="string">'P_E'</span>}
0290                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_evap'</span>) || ~multi_out
0291                     <span class="comment">% Precipitation</span>
0292                     prate_varid=netcdf.defVar(nc,<span class="string">'precip'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0293                     netcdf.putAtt(nc,prate_varid,<span class="string">'long_name'</span>,<span class="string">'Precipitation'</span>);
0294                     netcdf.putAtt(nc,prate_varid,<span class="string">'description'</span>,<span class="string">'Precipitation, ocean lose water is negative'</span>);
0295                     netcdf.putAtt(nc,prate_varid,<span class="string">'units'</span>,<span class="string">'m s-1'</span>);
0296                     netcdf.putAtt(nc,prate_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0297                     netcdf.putAtt(nc,prate_varid,<span class="string">'coordinates'</span>,coordString);
0298                     netcdf.putAtt(nc,prate_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0299 
0300                     used_varids = [used_varids, <span class="string">'prate_varid'</span>];
0301                     used_fnames = [used_fnames, fnames{vv}];
0302                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0303                 <span class="keyword">end</span>
0304 
0305             <span class="keyword">case</span> <span class="string">'nswrs'</span>
0306                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_hfx'</span>) || ~multi_out
0307                     <span class="comment">% Shortwave radiation</span>
0308                     nswrs_varid=netcdf.defVar(nc,<span class="string">'short_wave'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0309                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'long_name'</span>,<span class="string">'Short Wave Radiation'</span>);
0310                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'units'</span>,<span class="string">'W m-2'</span>);
0311                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0312                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'coordinates'</span>,coordString);
0313                     netcdf.putAtt(nc,nswrs_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0314 
0315                     used_varids = [used_varids, <span class="string">'nswrs_varid'</span>];
0316                     used_fnames = [used_fnames, fnames{vv}];
0317                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0318                 <span class="keyword">end</span>
0319 
0320             <span class="keyword">case</span> <span class="string">'nlwrs'</span>
0321                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_hfx'</span>) || ~multi_out
0322                     <span class="comment">% Longwave radiation</span>
0323                     nlwrs_varid=netcdf.defVar(nc,<span class="string">'long_wave'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0324                     netcdf.putAtt(nc,nlwrs_varid,<span class="string">'long_name'</span>,<span class="string">'Long Wave Radiation'</span>);
0325                     netcdf.putAtt(nc,nlwrs_varid,<span class="string">'units'</span>,<span class="string">'W m-2'</span>);
0326                     netcdf.putAtt(nc,nlwrs_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0327                     netcdf.putAtt(nc,nlwrs_varid,<span class="string">'coordinates'</span>,coordString);
0328                     netcdf.putAtt(nc,nlwrs_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0329 
0330                     used_varids = [used_varids, <span class="string">'nlwrs_varid'</span>];
0331                     used_fnames = [used_fnames, fnames{vv}];
0332                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0333                 <span class="keyword">end</span>
0334 
0335             <span class="keyword">case</span> {<span class="string">'shtfl'</span>, <span class="string">'lhtfl'</span>, <span class="string">'nshf'</span>} <span class="comment">% , 'nlwrs', 'nswrs'}</span>
0336                 <span class="comment">% We can't trigger on nlwrs and nswrs here because they're</span>
0337                 <span class="comment">% the triggers for the net longwave and shortwave variables</span>
0338                 <span class="comment">% above. Instead, we need to use the latent heat flux</span>
0339                 <span class="comment">% variables as the triggers for the net heat flux.</span>
0340                 <span class="comment">% We also need to check for the existence of the &quot;net</span>
0341                 <span class="comment">% surface heat flux ('nshf')&quot; field which can be created before</span>
0342                 <span class="comment">% calling grid2fvcom. This approach means there's fewer</span>
0343                 <span class="comment">% calls to the (expensive) interpolation as the net surface</span>
0344                 <span class="comment">% heat flux is calculated before being interpolated onto</span>
0345                 <span class="comment">% the FVCOM grid. Set the nshf variable accordingly.</span>
0346                 <span class="keyword">if</span> strcmpi(fnames{vv}, <span class="string">'nshf'</span>)
0347                     nshf = 1;
0348                 <span class="keyword">end</span>
0349                 <span class="keyword">try</span>
0350                     <span class="comment">% We might have already made this attribute, so fail</span>
0351                     <span class="comment">% elegantly if we do. This is because we need to put</span>
0352                     <span class="comment">% all four of shtfl, lhtfl, nlwrs and nswrs to make</span>
0353                     <span class="comment">% Surface Net Heat Flux.</span>
0354                     <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_hfx'</span>) || ~multi_out
0355                         <span class="comment">% Surface net heat flux</span>
0356                         nhf_varid=netcdf.defVar(nc,<span class="string">'net_heat_flux'</span>,<span class="string">'NC_FLOAT'</span>,[node_dimid, time_dimid]);
0357                         netcdf.putAtt(nc,nhf_varid,<span class="string">'long_name'</span>,<span class="string">'Surface Net Heat Flux'</span>);
0358                         netcdf.putAtt(nc,nhf_varid,<span class="string">'units'</span>,<span class="string">'W m-2'</span>);
0359                         netcdf.putAtt(nc,nhf_varid,<span class="string">'grid'</span>,<span class="string">'fvcom_grid'</span>);
0360                         netcdf.putAtt(nc,nhf_varid,<span class="string">'coordinates'</span>,coordString);
0361                         netcdf.putAtt(nc,nhf_varid,<span class="string">'type'</span>,<span class="string">'data'</span>);
0362                     <span class="keyword">end</span>
0363                 <span class="keyword">end</span>
0364                 <span class="keyword">if</span> strcmpi(suffixes{i}, <span class="string">'_hfx'</span>) || ~multi_out
0365                     <span class="comment">% We need to save the current variable name even if we've</span>
0366                     <span class="comment">% already made its attribute.</span>
0367                     used_varids = [used_varids, <span class="string">'nhf_varid'</span>];
0368                     used_fnames = [used_fnames, fnames{vv}];
0369                     used_dims = [used_dims, <span class="string">'nNodes'</span>];
0370                 <span class="keyword">end</span>
0371 
0372             <span class="keyword">case</span> {<span class="string">'time'</span>, <span class="string">'lon'</span>, <span class="string">'lat'</span>, <span class="string">'x'</span>, <span class="string">'y'</span>}
0373                 <span class="keyword">continue</span>
0374 
0375             <span class="keyword">otherwise</span>
0376                 <span class="keyword">if</span> ftbverbose
0377                     warning(<span class="string">'Unknown or possibly unused input data type: %s'</span>, fnames{vv})
0378                 <span class="keyword">end</span>
0379         <span class="keyword">end</span>
0380     <span class="keyword">end</span>
0381 
0382     <span class="comment">% End definitions</span>
0383     netcdf.endDef(nc);
0384 
0385     <span class="comment">% Put the easy ones in first.</span>
0386     netcdf.putVar(nc,nv_varid, tri');
0387     netcdf.putVar(nc,time_varid,0,ntimes,data.time);
0388     netcdf.putVar(nc,itime_varid,0,ntimes,floor(data.time));
0389     netcdf.putVar(nc,itime2_varid,0,ntimes,mod(data.time,1)*24*3600*1000);
0390     netcdf.putVar(nc,x_varid,x);
0391     netcdf.putVar(nc,y_varid,y);
0392     netcdf.putVar(nc,xc_varid,xc);
0393     netcdf.putVar(nc,yc_varid,yc);
0394 
0395     <span class="comment">% Build the time string and output to NetCDF.</span>
0396     nStringOut = char();
0397     <span class="keyword">for</span> tt=1:ntimes
0398         [nYr, nMon, nDay, nHour, nMin, nSec] = mjulian2greg(data.time(tt));
0399         nDate = [nYr, nMon, nDay, nHour, nMin, nSec];
0400         nStringOut = [nStringOut, sprintf(<span class="string">'%04i/%02i/%02i %02i:%02i:%02i       '</span>,nDate)];
0401     <span class="keyword">end</span>
0402     netcdf.putVar(nc,times_varid,nStringOut);
0403 
0404     <span class="comment">% Now do the dynamic ones. Set the heat flux to not done (hf_done = 0)</span>
0405     <span class="comment">% until we hit one of the holy quad (shtfl, lhtfl, nlwrs and nswrs).</span>
0406     hf_done = 0;
0407     <span class="keyword">for</span> ff=1:length(used_fnames)
0408         <span class="keyword">if</span> ftbverbose
0409             fprintf(<span class="string">'write : %s... '</span>, used_fnames{ff})
0410         <span class="keyword">end</span>
0411         <span class="keyword">if</span> strcmpi(used_fnames{ff}, <span class="string">'shtfl'</span>) || strcmpi(used_fnames{ff}, <span class="string">'lhtfl'</span>) || strcmpi(used_fnames{ff}, <span class="string">'nlwrs'</span>) || strcmpi(used_fnames{ff}, <span class="string">'nswrs'</span>)
0412 
0413             hf_done = hf_done + 1;
0414 
0415             <span class="keyword">if</span> hf_done == 4 &amp;&amp; nshf == 0
0416                 <span class="keyword">if</span> ftbverbose
0417                     fprintf(<span class="string">'combining heat flux ... '</span>)
0418                 <span class="keyword">end</span>
0419                 <span class="comment">% We've got all four heat parameters, so dump them into the</span>
0420                 <span class="comment">% file. We have to flip the signs of the net fluxes and</span>
0421                 <span class="comment">% subtract the latent and sensible heat fluxes because</span>
0422                 <span class="comment">% NCEP's convention is positive upwards (out of the ocean)</span>
0423                 <span class="comment">% and negative downwards (into the ocean), whereas FVCOM is</span>
0424                 <span class="comment">% positive downwards (into the ocean) and negative upwards</span>
0425                 <span class="comment">% (out of the ocean).</span>
0426                 hf = -data.nlwrs.node + -data.nswrs.node - data.lhtfl.node - data.shtfl.node;
0427                 <span class="comment">%hf = data.shtfl.node + data.lhtfl.node + data.nlwrs.node + data.nswrs.node;</span>
0428                 netcdf.putVar(nc,nhf_varid,[0,0],[nNodes,ntimes],hf)
0429             <span class="keyword">elseif</span> strcmpi(used_fnames{ff}, <span class="string">'nswrs'</span>) || strcmpi(used_fnames{ff}, <span class="string">'nlwrs'</span>)
0430                 <span class="comment">% We've already done the net surface heat flux but we're on</span>
0431                 <span class="comment">% either of the other fluxes (short/long wave) which we</span>
0432                 <span class="comment">% need to dump. Do that here.</span>
0433                 <span class="keyword">if</span> strcmpi(used_dims{ff}, <span class="string">'nNodes'</span>)
0434                     eval([<span class="string">'netcdf.putVar(nc,'</span>,used_varids{ff},<span class="string">',[0,0],['</span>,used_dims{ff},<span class="string">',ntimes],data.'</span>,used_fnames{ff},<span class="string">'.node);'</span>])
0435                 <span class="keyword">else</span>
0436                     eval([<span class="string">'netcdf.putVar(nc,'</span>,used_varids{ff},<span class="string">',[0,0],['</span>,used_dims{ff},<span class="string">',ntimes],data.'</span>,used_fnames{ff},<span class="string">'.data);'</span>])
0437                 <span class="keyword">end</span>
0438             <span class="keyword">else</span>
0439                 <span class="comment">% We haven't got the precomputed net surface heat flux but</span>
0440                 <span class="comment">% we haven't yet got enough of the parameters to export the</span>
0441                 <span class="comment">% heat flux from the short + long + latent + sensible.</span>
0442                 <span class="comment">% Essentially this loop just does hf_done = hf_done + 1.</span>
0443             <span class="keyword">end</span>
0444         <span class="keyword">elseif</span> strcmpi(used_fnames{ff}, <span class="string">'nshf'</span>) &amp;&amp; nshf == 1
0445             <span class="keyword">if</span> ftbverbose
0446                 fprintf(<span class="string">'existing combined heat flux ... '</span>)
0447             <span class="keyword">end</span>
0448             <span class="comment">% We have pre-computed net surface heat flux, in which case set</span>
0449             <span class="comment">% hf_done to 4 and put the data into the netCDF. Also set the</span>
0450             <span class="comment">% nshf variable 1 to stop the net surface heat flux variable</span>
0451             <span class="comment">% being overwritten above.</span>
0452             hf_done = 4;
0453             netcdf.putVar(nc, nhf_varid, [0, 0], [nNodes, ntimes], data.nshf.node)
0454         <span class="keyword">else</span>
0455             <span class="comment">% One of the other data sets for which we can simply dump the</span>
0456             <span class="comment">% existing array without waiting for other data</span>
0457             <span class="keyword">if</span> strcmpi(used_dims{ff}, <span class="string">'nNodes'</span>)
0458                 eval([<span class="string">'netcdf.putVar(nc,'</span>,used_varids{ff},<span class="string">',[0,0],['</span>,used_dims{ff},<span class="string">',ntimes],data.'</span>,used_fnames{ff},<span class="string">'.node);'</span>])
0459             <span class="keyword">else</span>
0460                 eval([<span class="string">'netcdf.putVar(nc,'</span>,used_varids{ff},<span class="string">',[0,0],['</span>,used_dims{ff},<span class="string">',ntimes],data.'</span>,used_fnames{ff},<span class="string">'.data);'</span>])
0461             <span class="keyword">end</span>
0462         <span class="keyword">end</span>
0463         <span class="keyword">if</span> ftbverbose
0464             fprintf(<span class="string">'done.\n'</span>)
0465         <span class="keyword">end</span>
0466     <span class="keyword">end</span>
0467     <span class="keyword">if</span> hf_done &lt; 4
0468         <span class="comment">% hf_done might be higher than four, but unless it is at least</span>
0469         <span class="comment">% four, we haven't got everything we need.</span>
0470         warning(<span class="string">'Did not have all the required heat flux parameters. Need ''shtfl'', ''lhtfl'', ''nlwrs'' and ''nwsrs''.'</span>)
0471     <span class="keyword">end</span>
0472 
0473     <span class="comment">% Close the NetCDF file(s)</span>
0474     netcdf.close(nc);
0475 <span class="keyword">end</span>
0476 
0477 <span class="keyword">if</span> ftbverbose
0478     fprintf(<span class="string">'end   : %s \n'</span>, subname)
0479 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 04-Jun-2013 12:12:57 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>